<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>前往綠界付款</title>
  <link rel="stylesheet" href="redirect.css">
</head>
<body>
  <form id="pay" class="card" method="post"
        action="https://payment.ecpay.com.tw/Cashier/AioCheckOut/V5">
    <h1>前往綠界金流付款頁面</h1>
    <p>請點按鈕完成付款</p>
    <button type="submit">前往付款</button>
  </form>

  <script>
    /* -------- decode the ?p=... query string -------- */
    const qp   = new URLSearchParams(location.search);
    const enc  = qp.get('p') || '';
    const json = JSON.parse(atob(decodeURIComponent(enc)));
    console.log('[GitHub page] decoded payload:', json);

    /* helper ─ yyyy/MM/dd HH:mm:ss */
    const fmtDate = d => {
      const z = n => String(n).padStart(2,'0');
      return d.getFullYear()+'/'+z(d.getMonth()+1)+'/'+z(d.getDate())+' '+
             z(d.getHours())+':'+z(d.getMinutes())+':'+z(d.getSeconds());
    };

    /* build parameter object */
    const p = {
      MerchantID       : json.cfg.merchantId,
      MerchantTradeNo  : json.tno,
      MerchantTradeDate: fmtDate(new Date()),          // 👈 correct format
      PaymentType      : 'aio',
      TotalAmount      : json.amt,
      TradeDesc        : '商品訂單',
      ItemName         : '課程',
      ReturnURL        : 'https://www.sooooz.com/_functions/updateECPayTransaction',
      ClientBackURL    : 'https://www.sooooz.com/',
      OrderResultURL   : 'https://www.sooooz.com/_functions/paymentResult',
      ChoosePayment    : 'ALL',
      EncryptType      : '1',
      CustomField1     : json.cfg.wixTransactionId,
      CustomField2     : json.cfg.orderId,
      CheckMacValue    : json.cfg.mac                      // MAC came from server
    };

    /* inject hidden inputs & submit */
    const form = document.getElementById('pay');
    Object.entries(p).forEach(([k,v])=>{
      const inp   = document.createElement('input');
      inp.type    = 'hidden';
      inp.name    = k;
      inp.value   = v;
      form.appendChild(inp);
    });
    console.table(p);         // handy browser-side debug
    form.submit();            // auto-submit; comment out if you want manual
  </script>
</body>
</html>
